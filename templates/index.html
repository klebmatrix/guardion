import os, threading, time, io, qrcode, requests
from flask import Flask, render_template, send_file
from web3 import Web3

app = Flask(__name__)

# Configura√ß√µes de Rede
RPC_URL = os.environ.get("RPC_URL", "https://polygon-rpc.com")
w3 = Web3(Web3.HTTPProvider(RPC_URL))

# Endere√ßos dos M√≥dulos (Pegando do Render)
MODULOS = {
    "MOD_01": os.environ.get("WALLET_01", "0x000..."),
    "MOD_02": os.environ.get("WALLET_02", "0x000..."),
    "MOD_03": os.environ.get("WALLET_03", "0x000...")
}

def obter_preco_wbtc():
    """Busca o pre√ßo atual do Bitcoin na rede"""
    try:
        url = "https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT"
        res = requests.get(url).json()
        return float(res['price'])
    except:
        return 0

def agente_estrategico():
    print("üöÄ AGENTE ESTRAT√âGICO OMNI: Ativado.")
    preco_alvo = 0 # Define uma l√≥gica de entrada

    while True:
        preco_atual = obter_preco_wbtc()
        print(f"üìä Pre√ßo atual BTC: ${preco_atual}")

        for mod, addr in MODULOS.items():
            if "0x" not in addr: continue
            
            try:
                # 1. Verifica se h√° saldo de USDC na carteira
                # (Aqui usamos uma checagem simples de saldo nativo para exemplo)
                saldo = w3.eth.get_balance(addr)
                
                if saldo > 0:
                    # L√ìGICA DE VANTAGEM: S√≥ compra se o pre√ßo n√£o estiver em pico
                    # Ou simplesmente executa se houver saldo e a taxa estiver baixa
                    print(f"üí∞ {mod}: Saldo detectado! Analisando oportunidade...")
                    
                    if preco_atual > 0:
                        print(f"‚ö° EXECUTANDO COMPRA VANTAJOSA: {mod} trocando USDC por WBTC")
                        # Aqui entra a fun√ß√£o de swap real com sua PRIVATE_KEY
                
            except Exception as e:
                print(f"‚ö†Ô∏è Erro no {mod}: {e}")
        
        time.sleep(60) # Analisa o mercado a cada 1 minuto

threading.Thread(target=agente_estrategico, daemon=True).start()

@app.route('/')
def home():
    return render_template('index.html', modulos=MODULOS)

@app.route('/qr/<path:text>')
def qr(text):
    img = qrcode.make(text)
    buf = io.BytesIO()
    img.save(buf, format='PNG')
    buf.seek(0)
    return send_file(buf, mimetype='image/png')

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=10000)